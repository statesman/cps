var fs = require('fs'),
    _ = require('underscore'),
    simplify = require('simplify-geojson');

var geojsonTx = JSON.parse(fs.readFileSync('../data/txCounties.geojson', 'utf8'));

var countyData = {
  "Andrews": 1,
  "Angelina": 4,
  "Aransas": 1,
  "Atascosa": 4,
  "Bastrop": 2,
  "Bee": 2,
  "Bell": 12,
  "Bexar": 64,
  "Bosque": 1,
  "Bowie": 4,
  "Brazoria": 9,
  "Brazos": 4,
  "Brown": 1,
  "Burleson": 2,
  "Burnet": 4,
  "Calhoun": 1,
  "Cameron": 14,
  "Camp": 1,
  "Cass": 2,
  "Chambers": 1,
  "Cherokee": 4,
  "Collin": 9,
  "Comal": 3,
  "Cooke": 2,
  "Coryell": 2,
  "Crosby": 1,
  "Dallam": 1,
  "Dallas": 65,
  "Denton": 11,
  "Donley": 1,
  "Duval": 3,
  "Ector": 15,
  "El Paso": 15,
  "Ellis": 4,
  "Erath": 2,
  "Falls": 1,
  "Fannin": 1,
  "Fort Bend": 13,
  "Frio": 1,
  "Galveston": 7,
  "Gray": 1,
  "Grayson": 6,
  "Gregg": 8,
  "Guadalupe": 4,
  "Hamilton": 1,
  "Hansford": 1,
  "Hardin": 2,
  "Harris": 143,
  "Harrison": 3,
  "Henderson": 2,
  "Hidalgo": 16,
  "Hill": 1,
  "Houston": 1,
  "Howard": 2,
  "Hunt": 4,
  "Hutchinson": 1,
  "Jackson": 1,
  "Jasper": 1,
  "Jefferson": 18,
  "Jim Wells": 2,
  "Johnson": 6,
  "Jones": 1,
  "Kaufman": 1,
  "Kerr": 3,
  "Kleberg": 1,
  "Lamar": 3,
  "Lamb": 1,
  "Lee": 2,
  "Liberty": 3,
  "Live Oak": 1,
  "Llano": 1,
  "Lubbock": 5,
  "Madison": 1,
  "Marion": 1,
  "Matagorda": 5,
  "McLennan": 7,
  "Medina": 1,
  "Midland": 3,
  "Montague": 1,
  "Montgomery": 12,
  "Moore": 3,
  "Morris": 1,
  "Navarro": 1,
  "Newton": 1,
  "Nueces": 17,
  "Orange": 4,
  "Palo Pinto": 1,
  "Panola": 1,
  "Parker": 3,
  "Polk": 4,
  "Potter": 7,
  "Red River": 1,
  "Reeves": 1,
  "Refugio": 1,
  "Rockwall": 1,
  "Rusk": 3,
  "Sabine": 1,
  "San Jacinto": 2,
  "San Patricio": 5,
  "Scurry": 1,
  "Shelby": 2,
  "Smith": 10,
  "Swisher": 1,
  "Tarrant": 53,
  "Taylor": 4,
  "Tom Green": 4,
  "Travis": 21,
  "Trinity": 1,
  "Tyler": 1,
  "Uvalde": 4,
  "Van Zandt": 3,
  "Victoria": 4,
  "Waller": 2,
  "Webb": 13,
  "Wichita": 5,
  "Willacy": 1,
  "Williamson": 5,
  "Wise": 3,
  "Wood": 3,
  "Young": 2,
  "Zapata": 1
};

// 2012 census
var population = {
  "Andrews County": 4646,
  "Angelina County": 23147,
  "Aransas County": 4523,
  "Archer County": 2078,
  "Armstrong County": 384,
  "Atascosa County": 13053,
  "Austin County": 7136,
  "Bailey County": 2205,
  "Bandera County": 3866,
  "Bastrop County": 19382,
  "Baylor County": 706,
  "Bee County": 6885,
  "Bell County": 89247,
  "Bexar County": 469912,
  "Blanco County": 2238,
  "Borden County": 204,
  "Bosque County": 4020,
  "Bowie County": 22426,
  "Brazoria County": 87748,
  "Brazos County": 40559,
  "Brewster County": 1893,
  "Briscoe County": 350,
  "Brooks County": 1939,
  "Brown County": 8982,
  "Burleson County": 4029,
  "Burnet County": 9842,
  "Caldwell County": 9809,
  "Calhoun County": 5612,
  "Callahan County": 3137,
  "Cameron County": 134018,
  "Camp County": 3290,
  "Carson County": 1564,
  "Cass County": 6910,
  "Castro County": 2508,
  "Chambers County": 9909,
  "Cherokee County": 13104,
  "Childress County": 1503,
  "Clay County": 2422,
  "Cochran County": 900,
  "Coke County": 659,
  "Coleman County": 1933,
  "Collin County": 228906,
  "Collingsworth County": 843,
  "Colorado County": 4882,
  "Comal County": 26263,
  "Comanche County": 3285,
  "Concho County": 566,
  "Cooke County": 9632,
  "Coryell County": 20517,
  "Cottle County": 270,
  "Crane County": 1292,
  "Crockett County": 922,
  "Crosby County": 1718,
  "Culberson County": 651,
  "Dallam County": 2127,
  "Dallas County": 660333,
  "Dawson County": 3288,
  "Deaf Smith County": 6283,
  "Delta County": 1190,
  "Denton County": 186404,
  "DeWitt County": 4481,
  "Dickens County": 443,
  "Dimmit County": 3055,
  "Donley County": 734,
  "Duval County": 2857,
  "Eastland County": 4088,
  "Ector County": 41341,
  "Edwards County": 374,
  "Ellis County": 43109,
  "El Paso County": 240424,
  "Erath County": 8487,
  "Falls County": 3844,
  "Fannin County": 7340,
  "Fayette County": 5370,
  "Fisher County": 889,
  "Floyd County": 1829,
  "Foard County": 286,
  "Fort Bend County": 177241,
  "Franklin County": 2613,
  "Freestone County": 4562,
  "Frio County": 4284,
  "Gaines County": 6237,
  "Galveston County": 74612,
  "Garza County": 1116,
  "Gillespie County": 4938,
  "Glasscock County": 326,
  "Goliad County": 1632,
  "Gonzales County": 5406,
  "Gray County": 5710,
  "Grayson County": 29041,
  "Gregg County": 31325,
  "Grimes County": 5973,
  "Guadalupe County": 36968,
  "Hale County": 10371,
  "Hall County": 844,
  "Hamilton County": 1784,
  "Hansford County": 1663,
  "Hardeman County": 883,
  "Hardin County": 14054,
  "Harris County": 1160790,
  "Harrison County": 16925,
  "Hartley County": 1296,
  "Haskell County": 1210,
  "Hays County": 39898,
  "Hemphill County": 1175,
  "Henderson County": 17766,
  "Hidalgo County": 271796,
  "Hill County": 8466,
  "Hockley County": 6190,
  "Hood County": 10912,
  "Hopkins County": 9030,
  "Houston County": 4675,
  "Howard County": 7866,
  "Hudspeth County": 950,
  "Hunt County": 21198,
  "Hutchinson County": 5808,
  "Irion County": 388,
  "Jack County": 1939,
  "Jackson County": 3671,
  "Jasper County": 8879,
  "Jeff Davis County": 426,
  "Jefferson County": 60211,
  "Jim Hogg County": 1202,
  "Jim Wells County": 11831,
  "Johnson County": 40958,
  "Jones County": 3461,
  "Karnes County": 2950,
  "Kaufman County": 29889,
  "Kendall County": 8399,
  "Kenedy County": 152,
  "Kent County": 192,
  "Kerr County": 9815,
  "Kimble County": 759,
  "King County": 48,
  "Kinney County": 800,
  "Kleberg County": 7891,
  "Knox County": 945,
  "Lamar County": 11905,
  "Lamb County": 4077,
  "Lampasas County": 4933,
  "La Salle County": 1911,
  "Lavaca County": 4509,
  "Lee County": 4124,
  "Leon County": 3787,
  "Liberty County": 19217,
  "Limestone County": 5468,
  "Lipscomb County": 957,
  "Live Oak County": 2300,
  "Llano County": 3035,
  "Loving County": 8,
  "Lubbock County": 68546,
  "Lynn County": 1588,
  "McCulloch County": 2042,
  "McLennan County": 59747,
  "McMullen County": 88,
  "Madison County": 2960,
  "Marion County": 1948,
  "Martin County": 1465,
  "Mason County": 779,
  "Matagorda County": 9493,
  "Maverick County": 18211,
  "Medina County": 11739,
  "Menard County": 607,
  "Midland County": 39097,
  "Milam County": 6353,
  "Mills County": 1213,
  "Mitchell County": 1854,
  "Montague County": 4527,
  "Montgomery County": 129539,
  "Moore County": 7010,
  "Morris County": 2959,
  "Motley County": 298,
  "Nacogdoches County": 15202,
  "Navarro County": 12821,
  "Newton County": 3254,
  "Nolan County": 3747,
  "Nueces County": 88439,
  "Ochiltree County": 3321,
  "Oldham County": 653,
  "Orange County": 20445,
  "Palo Pinto County": 6881,
  "Panola County": 5823,
  "Parker County": 29639,
  "Parmer County": 3121,
  "Pecos County": 3823,
  "Polk County": 9530,
  "Potter County": 33657,
  "Presidio County": 2085,
  "Rains County": 2302,
  "Randall County": 30560,
  "Reagan County": 1016,
  "Real County": 638,
  "Red River County": 2694,
  "Reeves County": 3087,
  "Refugio County": 1733,
  "Roberts County": 259,
  "Robertson County": 4160,
  "Rockwall County": 23682,
  "Runnels County": 2577,
  "Rusk County": 12273,
  "Sabine County": 2034,
  "San Augustine County": 1857,
  "San Jacinto County": 6322,
  "San Patricio County": 18112,
  "San Saba County": 1251,
  "Schleicher County": 990,
  "Scurry County": 4294,
  "Shackelford County": 799,
  "Shelby County": 6817,
  "Sherman County": 928,
  "Smith County": 53985,
  "Somervell County": 2132,
  "Starr County": 20687,
  "Stephens County": 2205,
  "Sterling County": 378,
  "Stonewall County": 338,
  "Sutton County": 1208,
  "Swisher County": 2012,
  "Tarrant County": 512553,
  "Taylor County": 32380,
  "Terrell County": 139,
  "Terry County": 3315,
  "Throckmorton County": 336,
  "Titus County": 9692,
  "Tom Green County": 26267,
  "Travis County": 251393,
  "Trinity County": 3053,
  "Tyler County": 4303,
  "Upshur County": 9749,
  "Upton County": 933,
  "Uvalde County": 7583,
  "Val Verde County": 14410,
  "Van Zandt County": 12451,
  "Victoria County": 23262,
  "Walker County": 11023,
  "Waller County": 10607,
  "Ward County": 2985,
  "Washington County": 7424,
  "Webb County": 88905,
  "Wharton County": 10906,
  "Wheeler County": 1409,
  "Wichita County": 30218,
  "Wilbarger County": 3331,
  "Willacy County": 5782,
  "Williamson County": 124798,
  "Wilson County": 11292,
  "Winkler County": 2168,
  "Wise County": 15411,
  "Wood County": 8522,
  "Yoakum County": 2567,
  "Young County": 4439,
  "Zapata County": 4826,
  "Zavala County": 3686
};

var buildFeatures = function(data, geoJson) {
  var features = [];

  // Loop over each result from the DB
  _.each(data, function(count, county) {

    // Find a matching feature/county in the GeoJSON file and copy it into
    // our new features array, then return TRUE to stop the loop
    _.find(geoJson.features, function(feature) {
      var countyName = county + ' County';
      if(feature.properties.COUNTY === countyName) {
        features.push({
          type: 'Feature',
          properties: {
            count: count,
            name: countyName,
            perCapita: Math.round(count / population[countyName] * 1000 * 100) / 100,
            under18: population[countyName]
          },
          geometry: feature.geometry
        });
        return true;
      }
    });

  });

  return features;
};

var writeGeoJson = function(name, features) {
  var geo = {
    type: 'FeatureCollection',
    features: features
  };
  fs.writeFileSync('../../public/data/' + name + '.json', JSON.stringify(simplify(geo, '.05')));
};

writeGeoJson('deathsByCounty', buildFeatures(countyData, geojsonTx));
