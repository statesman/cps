var fs = require('fs'),
    _ = require('underscore'),
    simplify = require('simplify-geojson');

var geojsonTx = JSON.parse(fs.readFileSync('../data/txCounties.geojson', 'utf8'));

var countyData = {
  "Andrews": 1,
  "Angelina": 4,
  "Aransas": 1,
  "Atascosa": 4,
  "Bastrop": 2,
  "Bee": 2,
  "Bell": 12,
  "Bexar": 64,
  "Bosque": 1,
  "Bowie": 4,
  "Brazoria": 9,
  "Brazos": 4,
  "Brown": 1,
  "Burleson": 2,
  "Burnet": 4,
  "Calhoun": 1,
  "Cameron": 14,
  "Camp": 1,
  "Cass": 2,
  "Chambers": 1,
  "Cherokee": 4,
  "Collin": 9,
  "Comal": 3,
  "Cooke": 2,
  "Coryell": 2,
  "Crosby": 1,
  "Dallam": 1,
  "Dallas": 65,
  "Denton": 11,
  "Donley": 1,
  "Duval": 3,
  "Ector": 15,
  "El Paso": 15,
  "Ellis": 4,
  "Erath": 2,
  "Falls": 1,
  "Fannin": 1,
  "Fort Bend": 13,
  "Frio": 1,
  "Galveston": 7,
  "Gray": 1,
  "Grayson": 6,
  "Gregg": 8,
  "Guadalupe": 4,
  "Hamilton": 1,
  "Hansford": 1,
  "Hardin": 2,
  "Harris": 143,
  "Harrison": 3,
  "Henderson": 2,
  "Hidalgo": 16,
  "Hill": 1,
  "Houston": 1,
  "Howard": 2,
  "Hunt": 4,
  "Hutchinson": 1,
  "Jackson": 1,
  "Jasper": 1,
  "Jefferson": 18,
  "Jim Wells": 2,
  "Johnson": 6,
  "Jones": 1,
  "Kaufman": 1,
  "Kerr": 3,
  "Kleberg": 1,
  "Lamar": 3,
  "Lamb": 1,
  "Lee": 2,
  "Liberty": 3,
  "Live Oak": 1,
  "Llano": 1,
  "Lubbock": 5,
  "Madison": 1,
  "Marion": 1,
  "Matagorda": 5,
  "McLennan": 7,
  "Medina": 1,
  "Midland": 3,
  "Montague": 1,
  "Montgomery": 12,
  "Moore": 3,
  "Morris": 1,
  "Navarro": 1,
  "Newton": 1,
  "Nueces": 17,
  "Orange": 4,
  "Palo Pinto": 1,
  "Panola": 1,
  "Parker": 3,
  "Polk": 4,
  "Potter": 7,
  "Red River": 1,
  "Reeves": 1,
  "Refugio": 1,
  "Rockwall": 1,
  "Rusk": 3,
  "Sabine": 1,
  "San Jacinto": 2,
  "San Patricio": 5,
  "Scurry": 1,
  "Shelby": 2,
  "Smith": 10,
  "Swisher": 1,
  "Tarrant": 53,
  "Taylor": 4,
  "Tom Green": 4,
  "Travis": 21,
  "Trinity": 1,
  "Tyler": 1,
  "Uvalde": 4,
  "Van Zandt": 3,
  "Victoria": 4,
  "Waller": 2,
  "Webb": 13,
  "Wichita": 5,
  "Willacy": 1,
  "Williamson": 5,
  "Wise": 3,
  "Wood": 3,
  "Young": 2,
  "Zapata": 1
};

// 2012 census
var population = {
  "Andrews County": 16117,
  "Angelina County": 87597,
  "Aransas County": 23818,
  "Archer County": 8735,
  "Armstrong County": 1944,
  "Atascosa County": 46446,
  "Austin County": 28618,
  "Bailey County": 7130,
  "Bandera County": 20537,
  "Bastrop County": 74763,
  "Baylor County": 3623,
  "Bee County": 32527,
  "Bell County": 323037,
  "Bexar County": 1785704,
  "Blanco County": 10655,
  "Borden County": 616,
  "Bosque County": 18125,
  "Bowie County": 93148,
  "Brazoria County": 324769,
  "Brazos County": 200665,
  "Brewster County": 9316,
  "Briscoe County": 1561,
  "Brooks County": 7161,
  "Brown County": 37825,
  "Burleson County": 17291,
  "Burnet County": 43448,
  "Caldwell County": 38734,
  "Calhoun County": 21609,
  "Callahan County": 13517,
  "Cameron County": 415557,
  "Camp County": 12449,
  "Carson County": 6157,
  "Cass County": 30166,
  "Castro County": 8164,
  "Chambers County": 36196,
  "Cherokee County": 51206,
  "Childress County": 7029,
  "Clay County": 10535,
  "Cochran County": 3046,
  "Coke County": 3231,
  "Coleman County": 8675,
  "Collin County": 834642,
  "Collingsworth County": 3036,
  "Colorado County": 20696,
  "Comal County": 114384,
  "Comanche County": 13765,
  "Concho County": 4010,
  "Cooke County": 38688,
  "Coryell County": 77231,
  "Cottle County": 1486,
  "Crane County": 4562,
  "Crockett County": 3743,
  "Crosby County": 6126,
  "Culberson County": 2290,
  "Dallam County": 6996,
  "Dallas County": 2453843,
  "Dawson County": 13640,
  "Deaf Smith County": 19360,
  "Delta County": 5329,
  "Denton County": 707304,
  "DeWitt County": 20465,
  "Dickens County": 2323,
  "Dimmit County": 10461,
  "Donley County": 3598,
  "Duval County": 11717,
  "Eastland County": 18421,
  "Ector County": 144325,
  "Edwards County": 1968,
  "Ellis County": 153969,
  "El Paso County": 827398,
  "Erath County": 39321,
  "Falls County": 17610,
  "Fannin County": 33831,
  "Fayette County": 24695,
  "Fisher County": 3844,
  "Floyd County": 6367,
  "Foard County": 1307,
  "Fort Bend County": 627293,
  "Franklin County": 10640,
  "Freestone County": 19515,
  "Frio County": 17702,
  "Gaines County": 18413,
  "Galveston County": 300484,
  "Garza County": 6412,
  "Gillespie County": 25153,
  "Glasscock County": 1259,
  "Goliad County": 7351,
  "Gonzales County": 20045,
  "Gray County": 22978,
  "Grayson County": 121935,
  "Gregg County": 122658,
  "Grimes County": 26783,
  "Guadalupe County": 139841,
  "Hale County": 36385,
  "Hall County": 3293,
  "Hamilton County": 8307,
  "Hansford County": 5521,
  "Hardeman County": 4082,
  "Hardin County": 55190,
  "Harris County": 4253700,
  "Harrison County": 67450,
  "Hartley County": 6144,
  "Haskell County": 5901,
  "Hays County": 168990,
  "Hemphill County": 4080,
  "Henderson County": 79094,
  "Hidalgo County": 806552,
  "Hill County": 35115,
  "Hockley County": 23072,
  "Hood County": 52044,
  "Hopkins County": 35469,
  "Houston County": 23161,
  "Howard County": 35408,
  "Hudspeth County": 3337,
  "Hunt County": 87079,
  "Hutchinson County": 21922,
  "Irion County": 1573,
  "Jack County": 8983,
  "Jackson County": 14255,
  "Jasper County": 35923,
  "Jeff Davis County": 2307,
  "Jefferson County": 251813,
  "Jim Hogg County": 5249,
  "Jim Wells County": 41754,
  "Johnson County": 153441,
  "Jones County": 19973,
  "Karnes County": 15233,
  "Kaufman County": 106753,
  "Kendall County": 35956,
  "Kenedy County": 431,
  "Kent County": 839,
  "Kerr County": 49786,
  "Kimble County": 4560,
  "King County": 276,
  "Kinney County": 3603,
  "Kleberg County": 32025,
  "Knox County": 3789,
  "Lamar County": 49811,
  "Lamb County": 14008,
  "Lampasas County": 20107,
  "La Salle County": 7109,
  "Lavaca County": 19468,
  "Lee County": 16601,
  "Leon County": 16803,
  "Liberty County": 76571,
  "Limestone County": 23585,
  "Lipscomb County": 3480,
  "Live Oak County": 11664,
  "Llano County": 19085,
  "Loving County": 71,
  "Lubbock County": 285760,
  "Lynn County": 5783,
  "McCulloch County": 8313,
  "McLennan County": 238707,
  "McMullen County": 726,
  "Madison County": 13677,
  "Marion County": 10324,
  "Martin County": 5017,
  "Mason County": 4003,
  "Matagorda County": 36547,
  "Maverick County": 55365,
  "Medina County": 46765,
  "Menard County": 2240,
  "Midland County": 146645,
  "Milam County": 24157,
  "Mills County": 4828,
  "Mitchell County": 9336,
  "Montague County": 19565,
  "Montgomery County": 485047,
  "Moore County": 22313,
  "Morris County": 12787,
  "Motley County": 1202,
  "Nacogdoches County": 66034,
  "Navarro County": 47979,
  "Newton County": 14200,
  "Nolan County": 14924,
  "Nueces County": 347691,
  "Ochiltree County": 10728,
  "Oldham County": 2060,
  "Orange County": 82977,
  "Palo Pinto County": 27856,
  "Panola County": 24020,
  "Parker County": 119712,
  "Parmer County": 10183,
  "Pecos County": 15619,
  "Polk County": 45656,
  "Potter County": 122335,
  "Presidio County": 7525,
  "Rains County": 10943,
  "Randall County": 125082,
  "Reagan County": 3475,
  "Real County": 3369,
  "Red River County": 12694,
  "Reeves County": 13798,
  "Refugio County": 7259,
  "Roberts County": 854,
  "Robertson County": 16545,
  "Rockwall County": 83021,
  "Runnels County": 10449,
  "Rusk County": 54026,
  "Sabine County": 10433,
  "San Augustine County": 8818,
  "San Jacinto County": 27126,
  "San Patricio County": 65600,
  "San Saba County": 6002,
  "Schleicher County": 3264,
  "Scurry County": 17126,
  "Shackelford County": 3356,
  "Shelby County": 26019,
  "Sherman County": 3073,
  "Smith County": 214821,
  "Somervell County": 8598,
  "Starr County": 61615,
  "Stephens County": 9464,
  "Sterling County": 1191,
  "Stonewall County": 1475,
  "Sutton County": 3950,
  "Swisher County": 7891,
  "Tarrant County": 1880153,
  "Taylor County": 133473,
  "Terrell County": 917,
  "Terry County": 12613,
  "Throckmorton County": 1601,
  "Titus County": 32663,
  "Tom Green County": 113281,
  "Travis County": 1095584,
  "Trinity County": 14309,
  "Tyler County": 21458,
  "Upshur County": 39995,
  "Upton County": 3283,
  "Uvalde County": 26752,
  "Val Verde County": 48705,
  "Van Zandt County": 52427,
  "Victoria County": 89269,
  "Walker County": 68408,
  "Waller County": 44357,
  "Ward County": 10879,
  "Washington County": 34093,
  "Webb County": 259172,
  "Wharton County": 41285,
  "Wheeler County": 5626,
  "Wichita County": 131559,
  "Wilbarger County": 13258,
  "Willacy County": 22058,
  "Williamson County": 456232,
  "Wilson County": 44370,
  "Winkler County": 7330,
  "Wise County": 60432,
  "Wood County": 42022,
  "Yoakum County": 8075,
  "Young County": 18339,
  "Zapata County": 14290,
  "Zavala County": 11961
};

var buildFeatures = function(data, geoJson) {
  var features = [];

  // Loop over each result from the DB
  _.each(data, function(count, county) {

    // Find a matching feature/county in the GeoJSON file and copy it into
    // our new features array, then return TRUE to stop the loop
    _.find(geoJson.features, function(feature) {
      var countyName = county + ' County';
      if(feature.properties.COUNTY === countyName) {
        features.push({
          type: 'Feature',
          properties: {
            count: count,
            name: countyName,
            perCapita: Math.round(count / population[countyName] * 1000 * 100) / 100
          },
          geometry: feature.geometry
        });
        return true;
      }
    });

  });

  return features;
};

var writeGeoJson = function(name, features) {
  var geo = {
    type: 'FeatureCollection',
    features: features
  };
  fs.writeFileSync('../../public/data/' + name + '.json', JSON.stringify(simplify(geo, '.05')));
};

writeGeoJson('deathsByCounty', buildFeatures(countyData, geojsonTx));
